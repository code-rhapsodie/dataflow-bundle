language: php

sudo: false

cache:
  directories:
    - $HOME/.composer/cache

branches:
  only:
    - master
    - /^\d+\.\d+$/
    - travis-setup

env:
  global:
    - SYMFONY_DEPRECATIONS_HELPER="max[self]=0"
    - PHPUNIT_FLAGS="-v"
    - PHPUNIT_ENABLED="true"
    - STABILITY=stable
    - COVERALLS_ENABLED="false"

matrix:
  fast_finish: true
  include:
    - php: '8.0'
      env:
          - SYMFONY_VERSION=3.4.*
    - php: '8.0'
      env:
          - SYMFONY_VERSION=4.4.*
    - php: '8.0'
      env:
          - SYMFONY_VERSION=5.4.*
    - php: '8.0'
      env:
          - SYMFONY_VERSION=6.0.*
    - php: '8.1'
      env:
          - SYMFONY_VERSION=3.4.*
    - php: '8.1'
      env:
          - SYMFONY_VERSION=4.4.*
    - php: '8.1'
      env:
          - SYMFONY_VERSION=5.4.*
    - php: '8.1'
      env:
          - SYMFONY_VERSION=6.0.*

before_install:
  - if [[ "$SYMFONY_VERSION" != "" ]]; then
      travis_retry composer global require "symfony/flex:^1.4";
      composer config extra.symfony.require $SYMFONY_VERSION;
    fi
  - if [[ "$STABILITY" != "stable" ]]; then
      travis_retry composer config minimum-stability $STABILITY;
    fi
  - if [[ "$COVERALLS_ENABLED" != "true" ]]; then
      phpenv config-rm xdebug.ini || true;
    fi
  - if [[ "$COVERALLS_ENABLED" == "true" ]]; then
      travis_retry composer require --dev php-coveralls/php-coveralls:^2.0 --no-update $COMPOSER_FLAGS;
    fi

install:
  - travis_retry composer update --prefer-dist --no-interaction --no-progress --ansi $COMPOSER_FLAGS

script: ./vendor/bin/phpunit $PHPUNIT_FLAGS

after_success:
  - if [[ "$PHPUNIT_ENABLED" == "true" && "$COVERALLS_ENABLED" == "true" ]]; then
    ./vendor/bin/php-coveralls -vvv --config .coveralls.yml;
    fi;
